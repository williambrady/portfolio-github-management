name: SAST Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run SDLC Code Scanner
        id: security-scan
        uses: williambrady/portfolio-code-scanner@v1
        with:
          scan-path: '.'
          output-formats: 'json,html,markdown,sarif'
          fail-on-severity: 'HIGH'
          verbose: 'false'

      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        if: always() && steps.security-scan.outputs.sarif-path != ''
        with:
          sarif_file: ${{ steps.security-scan.outputs.sarif-path }}
          category: 'sdlc-code-scanner'

      - name: Prepare Reports for Upload
        if: always()
        run: |
          REPORT_DIR="${{ steps.security-scan.outputs.report-path }}"
          if [[ -z "$REPORT_DIR" ]]; then
            REPORT_DIR=".sdlc-code-scanner-reports"
          fi
          echo "Report directory: $REPORT_DIR"
          if [[ -d "$REPORT_DIR" ]]; then
            echo "Contents:"
            ls -la "$REPORT_DIR"
            # Ensure files are flushed and readable
            sync
          else
            echo "Report directory not found"
          fi

      - name: Upload Scan Reports
        uses: actions/upload-artifact@v4
        if: always() && steps.security-scan.outputs.report-path != ''
        with:
          name: security-scan-reports
          path: ${{ steps.security-scan.outputs.report-path }}
          include-hidden-files: true
          if-no-files-found: warn
          retention-days: 30

      - name: Display Markdown Report
        if: always()
        run: |
          echo "::group::Security Scan Full Report"
          REPORT_DIR="${{ steps.security-scan.outputs.report-path }}"
          if [[ -z "$REPORT_DIR" ]]; then
            REPORT_DIR=".sdlc-code-scanner-reports"
          fi
          if [[ -d "$REPORT_DIR" ]]; then
            MD_REPORT=$(find "$REPORT_DIR" -name "*.md" -type f | head -1)
            if [[ -f "$MD_REPORT" ]]; then
              echo "Found report: $MD_REPORT"
              echo ""
              cat "$MD_REPORT"
            else
              echo "No markdown report found in $REPORT_DIR"
              echo "Files present:"
              ls -la "$REPORT_DIR" || echo "Cannot list directory"
            fi
          else
            echo "Report directory not found: $REPORT_DIR"
          fi
          echo "::endgroup::"

      - name: Post Scan Summary
        if: always()
        run: |
          echo "### Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | ${{ steps.security-scan.outputs.critical-count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| High | ${{ steps.security-scan.outputs.high-count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Medium | ${{ steps.security-scan.outputs.medium-count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Low | ${{ steps.security-scan.outputs.low-count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **${{ steps.security-scan.outputs.findings-count }}** |" >> $GITHUB_STEP_SUMMARY

      - name: Extract Top Findings for PR Comment
        id: top-findings
        if: github.event_name == 'pull_request' && always()
        run: |
          REPORT_DIR="${{ steps.security-scan.outputs.report-path }}"
          if [[ -z "$REPORT_DIR" ]]; then
            REPORT_DIR=".sdlc-code-scanner-reports"
          fi
          JSON_REPORT=$(find "$REPORT_DIR" -name "*.json" -type f 2>/dev/null | head -1)

          if [[ -f "$JSON_REPORT" ]]; then
            # Extract top 5 findings formatted for markdown, output as JSON-encoded string
            FINDINGS_JSON=$(python3 -c "
          import json

          with open('$JSON_REPORT', 'r') as f:
              data = json.load(f)

          findings = data.get('findings', [])
          severity_order = {'CRITICAL': 0, 'HIGH': 1, 'MEDIUM': 2, 'LOW': 3, 'INFO': 4}
          findings.sort(key=lambda x: severity_order.get(x.get('severity', 'INFO'), 5))

          lines = []

          # Get scanners run
          scanners = data.get('metadata', {}).get('scanners_run', [])
          if scanners:
              lines.append('**Scanners:** ' + ', '.join(scanners))
              lines.append('')

          if findings:
              lines.append('### Top Findings')
              lines.append('')
              for i, f in enumerate(findings[:5]):
                  sev = f.get('severity', 'INFO')
                  tool = f.get('tool', 'unknown')
                  title = f.get('title', f.get('rule_id', 'Unknown'))
                  file_path = f.get('file_path', 'N/A')
                  line = f.get('line_number')
                  loc = f'{file_path}:{line}' if line is not None else file_path
                  emoji = {'CRITICAL': ':red_circle:', 'HIGH': ':orange_circle:', 'MEDIUM': ':yellow_circle:', 'LOW': ':white_circle:'}.get(sev, ':white_circle:')
                  lines.append(f'{i+1}. {emoji} **{sev}** [{tool}] {title}')
                  lines.append(f'   \`{loc}\`')

          # Output as JSON-encoded string to safely pass to JavaScript
          print(json.dumps('\\n'.join(lines)))
          ")

            echo "findings_detail=$FINDINGS_JSON" >> "$GITHUB_OUTPUT"
          else
            echo 'findings_detail=""' >> "$GITHUB_OUTPUT"
          fi

      - name: Comment PR with Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const findings = '${{ steps.security-scan.outputs.findings-count }}';
            const critical = '${{ steps.security-scan.outputs.critical-count }}';
            const high = '${{ steps.security-scan.outputs.high-count }}';
            const medium = '${{ steps.security-scan.outputs.medium-count }}';
            const low = '${{ steps.security-scan.outputs.low-count }}';
            const status = '${{ steps.security-scan.outputs.scan-status }}';

            // Parse JSON-encoded findings detail
            let findingsDetail = '';
            try {
              const jsonStr = ${{ steps.top-findings.outputs.findings_detail }};
              findingsDetail = typeof jsonStr === 'string' ? jsonStr : '';
            } catch (e) {
              console.log('Could not parse findings detail:', e.message);
            }

            const statusEmoji = status === 'passed' ? ':white_check_mark:' : ':x:';

            let body = `## SDLC Code Scanner Security Scan ${statusEmoji}

            | Severity | Count |
            |----------|-------|
            | Critical | ${critical} |
            | High | ${high} |
            | Medium | ${medium} |
            | Low | ${low} |
            | **Total** | **${findings}** |

            `;

            if (findingsDetail && findingsDetail.trim()) {
              body += findingsDetail + '\n\n';
            }

            body += `*View the full report in the [Actions artifacts](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})*`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
